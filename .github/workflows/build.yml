name: Build

on:
  push:
    branches-ignore: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: flask_tutorial_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Setup environment
      uses: ./.github/actions/setup.yml

    - name: Run tests
      uses: ./.github/actions/test.yml

  lint:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Setup environment
      uses: ./.github/actions/setup.yml

    - name: Run linting
      uses: ./.github/actions/lint.yml

  security:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Setup environment
      uses: ./.github/actions/setup.yml

    - name: Run security scans
      uses: ./.github/actions/security.yml
      with:
        upload-artifacts: true

  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Setup environment
      uses: ./.github/actions/setup.yml

    - name: Build frontend assets
      run: make webpack

    - name: Test Docker build
      run: docker build -t flask-tutorial:${{ github.sha }} .

  sbom:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Setup environment
      uses: ./.github/actions/setup.yml

    - name: Generate SBOM
      uses: ./.github/actions/sbom.yml
      with:
        upload-artifacts: true
        retention-days: 30