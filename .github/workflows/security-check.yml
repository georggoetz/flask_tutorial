name: Security Check for Dependencies

on:
  pull_request:
    paths:
      - 'package.json'
      - 'package-lock.json'
      - 'requirements.txt'
      - 'pyproject.toml'

permissions:
  contents: read
  pull-requests: write

jobs:
  security-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Install npm dependencies
        run: npm install --no-optional

      - name: Run npm security audit
        id: npm-audit
        run: |
          echo "## 🔒 npm Security Audit" >> $GITHUB_STEP_SUMMARY
          
          # Run audit and capture output
          if npm audit --json > npm-audit.json 2>&1; then
            echo "✅ No security vulnerabilities found in npm packages" >> $GITHUB_STEP_SUMMARY
            echo "status=clean" >> $GITHUB_OUTPUT
          else
            # Parse audit results
            CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' npm-audit.json)
            HIGH=$(jq '.metadata.vulnerabilities.high // 0' npm-audit.json)
            MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' npm-audit.json)
            LOW=$(jq '.metadata.vulnerabilities.low // 0' npm-audit.json)
            
            echo "### Security Vulnerabilities Found:" >> $GITHUB_STEP_SUMMARY
            echo "- 🔴 Critical: $CRITICAL" >> $GITHUB_STEP_SUMMARY
            echo "- 🟠 High: $HIGH" >> $GITHUB_STEP_SUMMARY
            echo "- 🟡 Moderate: $MODERATE" >> $GITHUB_STEP_SUMMARY
            echo "- 🟢 Low: $LOW" >> $GITHUB_STEP_SUMMARY
            
            if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
              echo "status=vulnerable" >> $GITHUB_OUTPUT
              echo "❌ Critical or High vulnerabilities detected - manual review required" >> $GITHUB_STEP_SUMMARY
              exit 1
            else
              echo "status=low-risk" >> $GITHUB_OUTPUT
              echo "⚠️ Only moderate/low risk vulnerabilities - proceed with caution" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Upload audit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: npm-security-audit
          path: npm-audit.json

      - name: Install Python dependencies
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install .[dev]

      - name: Run Python security check
        run: |
          source .venv/bin/activate
          echo "## 🐍 Python Security Check" >> $GITHUB_STEP_SUMMARY
          
          # Install safety for security checking
          pip install safety
          
          if safety check --json > python-safety.json 2>&1; then
            echo "✅ No known security vulnerabilities in Python packages" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Python security issues found - check artifacts" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Python safety results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: python-security-check
          path: python-safety.json

      - name: Comment on PR
        uses: actions/github-script@v8
        if: always()
        with:
          script: |
            const auditStatus = "${{ steps.npm-audit.outputs.status }}";
            let comment = "## 🔒 Security Check Results\n\n";
            
            if (auditStatus === "clean") {
              comment += "✅ **All security checks passed!** Safe to merge.\n\n";
            } else if (auditStatus === "low-risk") {
              comment += "⚠️ **Low/moderate risk vulnerabilities found.** Review recommended before merge.\n\n";
            } else if (auditStatus === "vulnerable") {
              comment += "❌ **Critical/high security vulnerabilities detected!** Manual review required.\n\n";
              comment += "**Action required:** Check the security audit artifacts before merging.\n\n";
            }
            
            comment += "📊 Detailed results available in [workflow artifacts](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}).";
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
